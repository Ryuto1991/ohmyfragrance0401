# 基本的なチャット機能の動作確認手順

ご指摘の通り、テストカバレッジやパフォーマンス測定の前に、基本的なチャット機能が完全に動作していることを確認することが最優先事項です。以下に、具体的な動作確認手順と、考えられる問題点および対策をまとめます。

## 機能検証リスト

### 1. 基本的なチャット機能

#### 1.1 メッセージ送受信
- [ ] ユーザーがメッセージを入力して送信できること
- [ ] AIからの応答が正しく表示されること
- [ ] 長いメッセージも適切に表示されること
- [ ] メッセージが時系列順に表示されること
- [ ] 送信中の状態（ローディング）が表示されること
- [ ] 過去のメッセージ履歴が保持されていること

```bash
# メッセージ機能検証コマンド
npm run dev
# ブラウザで http://localhost:3000/fragrance-lab/chat にアクセス
# 以下のメッセージを送信テスト
# 1. 短いメッセージ: "こんにちは"
# 2. 長いメッセージ: "香水について教えてください。特に柑橘系の香りが好きですが、持続時間が長いものを探しています。トップノートからベースノートまで、バランスの良い香りのおすすめを教えてください。"
```

#### 1.2 エラー処理
- [ ] ネットワークエラー時の表示と回復
- [ ] APIレスポンスエラー時の適切なメッセージ表示
- [ ] 長時間応答がない場合のタイムアウト処理

```bash
# エラー処理テスト（開発者ツールでネットワーク切断）
# 1. Chromeの開発者ツールを開く
# 2. Networkタブで "Offline" を選択
# 3. メッセージを送信してエラー表示を確認
# 4. "Online" に戻して回復することを確認
```

### 2. 香り選択フロー

#### 2.1 フェーズ遷移
- [ ] welcomeからtopノート選択へ正しく遷移すること
- [ ] topからmiddleへ正しく遷移すること
- [ ] middleからbaseへ正しく遷移すること
- [ ] baseからfinalizedへ正しく遷移すること
- [ ] finalizedからcompleteへ正しく遷移すること
- [ ] 各フェーズでの進行状況が正しく表示されること

#### 2.2 香り選択機能
- [ ] 各フェーズで香りの選択肢が表示されること
- [ ] 選択した香りが正しく保存されること
- [ ] 選択済みの香りが視覚的に表示されること
- [ ] 全ての香りを選択した後にレシピが確定すること

#### 2.3 レシピ管理
- [ ] 作成したレシピがLocalStorageに保存されること
- [ ] 画面をリロードしてもレシピが保持されていること
- [ ] リセット機能で正しくレシピがクリアされること
- [ ] おまかせレシピ作成機能が動作すること

### 3. UIとUX

#### 3.1 レスポンシブデザイン
- [ ] モバイル画面で適切に表示されること
- [ ] デスクトップ画面で適切に表示されること
- [ ] タブレット画面で適切に表示されること
- [ ] 画面サイズ変更時に適切にレイアウトが調整されること

#### 3.2 アクセシビリティ
- [ ] キーボードでの操作が可能であること
- [ ] スクリーンリーダーでの読み上げが適切であること
- [ ] フォーカス状態が視覚的に表示されること
- [ ] コントラストが適切であること

#### 3.3 ユーザビリティ
- [ ] メッセージ入力欄にフォーカスが自動的に当たること
- [ ] 長いメッセージリストで自動スクロールすること
- [ ] ボタンやリンクのホバー状態が明確であること
- [ ] モバイルでのタップ領域が十分な大きさであること

### 4. パフォーマンスとエッジケース

#### 4.1 読み込み時間
- [ ] 初期表示が3秒以内に完了すること
- [ ] 大量のメッセージがある場合でもスムーズにスクロールできること
- [ ] チャット応答が5秒以内に表示されること

#### 4.2 エッジケース
- [ ] 極端に長いメッセージを送信しても適切に処理されること
- [ ] 特殊文字やHTML/JavaScriptタグが含まれるメッセージが安全に表示されること
- [ ] 複数のタブで同時に開いても正しく動作すること
- [ ] オフライン状態から復帰した時に正常に動作すること

## 検証方法

### 手動テスト

以下の手順で手動テストを実施します：

1. 開発サーバーを起動
   ```bash
   npm run dev
   ```

2. ブラウザで http://localhost:3000/fragrance-lab/chat にアクセス

3. 通常のチャットフロー検証
   - 初期メッセージを確認
   - 会話を開始（「柑橘系の香りが好きです」など）
   - 香りの選択肢が表示されることを確認
   - 香りを選択して次のフェーズに進むことを確認
   - すべてのフェーズを通過してレシピが完成することを確認

4. エッジケース検証
   - ネットワーク切断時の動作
   - ページのリロード後の状態回復
   - 複数デバイスでのレスポンシブ表示

### 自動化テスト

既に実装したテストに加えて、以下の実行でE2Eテストを行います：

```bash
# E2Eテスト実行（Playwrightを使用）
npx playwright test tests/fragrance-chat.spec.ts
```

## 問題発見時の対応手順

1. 問題を特定し、再現手順をドキュメント化
2. 関連するコンポーネントやフックのコードを確認
3. 原因を特定し、修正案を作成
4. 修正をテスト環境で検証
5. 修正が他の機能に影響していないことを確認
6. 修正をコミット

## よくある問題とその対策

### 1. 応答が表示されない問題

**考えられる原因:**
- APIエンドポイントへの接続エラー
- レスポンスの解析エラー
- 状態更新の失敗

**対策:**
```typescript
// api/chat/route.tsでエラーハンドリングを強化
try {
  // API処理
} catch (error) {
  console.error('Chat API error:', error);
  return NextResponse.json({ error: error.message }, { status: 500 });
}

// クライアント側でエラーハンドリングを強化
try {
  const response = await fetch('/api/chat', {...});
  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }
  // レスポンス処理
} catch (error) {
  setError(error);
  // エラー表示処理
}
```

### 2. フェーズ遷移の問題

**考えられる原因:**
- 状態更新ロジックのエラー
- 条件判定の誤り
- イベント伝播の問題

**対策:**
```typescript
// useChatPhases.tsでフェーズ遷移ロジックを明確化
const updatePhase = useCallback((newPhase: ChatPhase) => {
  // 現在のフェーズから指定されたフェーズへの遷移が許可されているか確認
  if (!isValidPhaseTransition(currentPhaseId, newPhase)) {
    console.warn(`Invalid phase transition: ${currentPhaseId} -> ${newPhase}`);
    return false;
  }
  
  setCurrentPhaseId(newPhase);
  // フェーズ変更イベントをログ
  console.log(`Phase changed: ${currentPhaseId} -> ${newPhase}`);
  return true;
}, [currentPhaseId]);
```

### 3. LocalStorage関連の問題

**考えられる原因:**
- SSRとの互換性エラー
- キー名の不一致
- JSONパース/シリアライズエラー

**対策:**
```typescript
// storage-service.tsでのエラーハンドリング強化
export const StorageService = {
  saveRecipe: (recipe: Partial<FragranceRecipe>) => {
    try {
      if (typeof window === 'undefined') return;
      localStorage.setItem(RECIPE_KEY, JSON.stringify(recipe));
    } catch (error) {
      console.error('Error saving recipe to localStorage:', error);
    }
  },
  
  getRecipe: (): Partial<FragranceRecipe> | null => {
    try {
      if (typeof window === 'undefined') return null;
      const data = localStorage.getItem(RECIPE_KEY);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('Error reading recipe from localStorage:', error);
      return null;
    }
  }
};
```

## 検証チェックリスト

基本機能が完全に動作していることを確認するためのチェックリストです：

- [ ] メッセージの送受信: 複数のメッセージを送受信できる
- [ ] 香り選択フロー: すべてのフェーズが正しく遷移する
- [ ] レシピ管理: レシピが保存され、リロード後も維持される
- [ ] エラー処理: ネットワークエラーから適切に回復する
- [ ] パフォーマンス: 読み込みと応答が適切な時間内に完了する
- [ ] レスポンシブデザイン: 様々な画面サイズで適切に表示される

基本的なチャット機能が正常に動作していることを確認した後で、テストカバレッジの拡張やパフォーマンス測定の自動化を進めることが適切です。
