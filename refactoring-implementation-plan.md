# フレグランスチャットリファクタリング実装計画

## 1. 既存コードとの統合

### 1.1 ページコンポーネントの置き換え
- [x] `utils/storage-service.ts`のサーバーサイドレンダリング対応実装完了
- [x] `components/chat/hooks/useRecipeManagement.ts`のサーバーサイドレンダリング対応実装完了
- [ ] `app/fragrance-lab/chat-demo/page.tsx`を`app/fragrance-lab/chat/page.tsx`と比較し、必要なカスタム機能を確認
- [ ] カスタム機能を維持したまま`app/fragrance-lab/chat/page.tsx`を更新
- [ ] 更新したページをテスト

### 1.2 コンポーネントの置き換え
- [ ] `components/fragrance-chat.tsx`と`components/chat/FragranceChat.tsx`の違いを分析
- [ ] 新しいコンポーネント構造に合わせて`components/fragrance-chat.tsx`を更新または削除
- [ ] すべての参照箇所をリファクタリングされたコンポーネントに更新

### 1.3 依存関係の更新
- [ ] 影響を受けるコンポーネントのインポート文を更新
- [ ] コンテキストプロバイダーの正しい使用を確認
- [ ] 循環依存関係がないことを確認

## 2. 型システムの整理

### 2.1 型定義の一貫性確保
- [ ] `app/fragrance-lab/chat/types.ts`の現在の型定義を確認
- [ ] 不足している型（`MessagePart`, `ChatResponse`など）を追加
- [ ] 既存の型と新しい型の命名の一貫性を確保

### 2.2 型の参照の更新
- [ ] すべてのコンポーネントで型のインポート文を確認
- [ ] 最新の型定義を使用するようにすべての参照を更新
- [ ] TypeScriptエラーがないことを確認

## 3. API互換性の確保

### 3.1 API呼び出しの検証
- [ ] 既存のAPIエンドポイントの使用方法を確認
- [ ] リファクタリングしたコードでも同じインターフェースを維持
- [ ] レスポンス処理のロジックに変更がないことを確認

### 3.2 データ形式の互換性
- [ ] リクエスト・レスポンスの形式が一貫していることを確認
- [ ] 変換ロジックがあれば、それが正しく機能することを確認

## 4. ローカルストレージの管理

### 4.1 サーバーサイドレンダリング対応
- [x] すべてのlocalStorage操作がサーバーサイドレンダリングに対応していることを確認
- [x] クライアントサイドでのみlocalStorageを使用するよう改修済み

### 4.2 キー管理の一貫性
- [ ] ストレージキーの定義と使用法を確認
- [ ] 各コンポーネントで一貫したアクセス方法を使用

## 5. 状態管理の統一

### 5.1 コンテキストの使用
- [ ] `ChatProvider`が正しく使用されていることを確認
- [ ] 状態更新の流れを確認
- [ ] 不要な再レンダリングがないことを確認

### 5.2 フックの使用
- [ ] 新しい分割されたフックがすべて正しく使用されていることを確認
- [ ] フック間の依存関係が正しく設定されていることを確認

## 6. テスト実装計画

### 6.1 ユニットテスト
- [ ] 各フックのテストを作成
- [ ] ユーティリティ関数のテストを作成
- [ ] モックデータと期待される結果を定義

### 6.2 コンポーネントテスト
- [ ] UIコンポーネントのレンダリングテストを作成
- [ ] ユーザー操作（クリック、入力など）のテストを作成
- [ ] 非同期処理（API呼び出しなど）のテストを作成

### 6.3 E2Eテスト
- [ ] 主要なユーザーフローのE2Eテストを作成
- [ ] エラーケースのテストを作成
- [ ] パフォーマンステストを作成（必要に応じて）

## 推奨実装順序

1. **型定義の更新**: まずは型システムを整理し、以降の作業の土台を整える
2. **コンポーネントの更新**: ChatProviderとFragranceChatを中心に、新しいコンポーネント構造を適用
3. **ページの更新**: リファクタリングされたコンポーネントをページに統合
4. **API互換性のチェック**: API呼び出しが正しく機能することを確認
5. **ローカルストレージの検証**: すべてのストレージ操作が正しく機能することを確認
6. **テストの実装**: 動作確認が取れた後にテストを実装して品質を確保

## 注意事項

- 段階的にリファクタリングを行い、各ステップで動作確認を行う
- localStorage関連のコードは既に修正済みなので、その部分の互換性に特に注意する
- 型定義の変更がある場合は、その影響範囲を慎重に確認する
- APIエンドポイントのインターフェースは維持し、既存の機能を壊さないようにする
