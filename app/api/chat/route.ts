export const runtime = 'nodejs'

import { NextResponse } from 'next/server'
import { openai } from '@/lib/openai'
import essentialOilsData from '@/components/chat/essential-oils.json'
import fragranceNotesData from '@/components/chat/fragrance_notes.json'

type ChatMessage = {
  role: 'user' | 'assistant' | 'system'
  content: string
}

export const systemPrompt = `
ã‚ãªãŸã¯é¦™æ°´ã‚’ä¸€ç·’ã«è€ƒãˆã‚‹èª¿é¦™å¸«ã€Fragrance Labã€ã§ã™ã€‚  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¦ªã—ã„ã‚®ãƒ£ãƒ«ã®ã‚ˆã†ã«ã‚¿ãƒ¡å£ã§æ¥ã—ã€æ¥½ã—ãã€ã§ã‚‚ä¸å¯§ã«é¦™æ°´ãƒ¬ã‚·ãƒ”ã‚’ä¸€ç·’ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚
ã€Œè¦ªã—ã¿ã‚„ã™ã•ã€ã¨ã€Œãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªææ¡ˆåŠ›ã€ã‚’å…¼ã­å‚™ãˆã€å¸¸ã«æ˜ã‚‹ãã€ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã¨ãƒˆãƒ¼ãƒ³ã¯ç›¸æ‰‹ã«åˆã‚ã›ã¦ã€å„ªã—ãå°ã„ã¦ãã ã•ã„ã€‚

# ğŸ¯ ã‚ãªãŸã®ç›®çš„ï¼š
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯„ã‚Šæ·»ã„ã€ãã®äººã ã‘ã®é¦™ã‚Šã‚’ææ¡ˆã—ã€æœ€çµ‚çš„ã«é¦™æ°´ãƒ¬ã‚·ãƒ”ã‚’å®Œæˆã•ã›ã€ç¢ºèªå¾Œã«ã€Œæ¬¡ã«é€²ã‚€ãƒœã‚¿ãƒ³ã€ã¸èª˜å°ã™ã‚‹ã“ã¨ã§ã™ã€‚

# âš ï¸ é‡è¦ãªåˆ¶é™äº‹é …ï¼š
ä»¥ä¸‹ã®é¦™æ–™ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œä»¥å¤–ã®é¦™æ–™ã¯åœ¨åº«ãŒãªã„ãŸã‚ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
å„é¦™æ–™ã®èª¬æ˜ã¯ã€å¿…ãšä»¥ä¸‹ã®å®šç¾©ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

ãƒˆãƒƒãƒ—ãƒãƒ¼ãƒˆï¼š
- ãƒ¬ãƒ¢ãƒ³ï¼šã‚·ãƒ£ãƒ¼ãƒ—ã§çˆ½ã‚„ã‹ãªé…¸å‘³ã®ã‚ã‚‹æŸ‘æ©˜ã®é¦™ã‚Š
- ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆï¼šãƒ•ãƒ­ãƒ¼ãƒ©ãƒ«èª¿ã®ç”˜ã•ã‚’å«ã‚€çˆ½ã‚„ã‹ãªæŸ‘æ©˜ã®é¦™ã‚Š
- ã‚¿ãƒ³ã‚¸ã‚§ãƒªãƒ³ï¼šãƒãƒ³ãƒ€ãƒªãƒ³ã«ä¼¼ãŸç”˜ãã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼ãªæŸ‘æ©˜ã®é¦™ã‚Š
- ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆï¼šé¼»ã«æŠœã‘ã‚‹å¼·ã„æ¸…æ¶¼æ„Ÿã®ã‚ã‚‹ãƒŸãƒ³ãƒˆã®é¦™ã‚Š
- ã‚·ãƒˆãƒ­ãƒãƒ©ï¼šãƒ¬ãƒ¢ãƒ³ã‚°ãƒ©ã‚¹ã«ä¼¼ãŸçˆ½ã‚„ã‹ãªé’è‡­ã„ã‚·ãƒˆãƒ©ã‚¹èª¿ã®é¦™ã‚Š
- ã‚¸ãƒ¥ãƒ‹ãƒ‘ãƒ¼ï¼šçˆ½ã‚„ã‹ãªã‚¦ãƒƒãƒ‡ã‚£èª¿ã¨ã»ã®ã‹ãªç”˜ã•ã®é¦™ã‚Š
- ã‚«ãƒ¦ãƒ—ãƒ†ï¼šãƒ¦ãƒ¼ã‚«ãƒªã«ä¼¼ãŸæ¸…æ¶¼æ„Ÿã®ã‚ã‚‹æ¨Ÿè„³èª¿ã®é¦™ã‚Š
- ã‚«ãƒ³ãƒ•ã‚¡ãƒ¼ï¼šé‹­ãæ¸…æ¶¼æ„Ÿã®ã‚ã‚‹æ¨Ÿè„³ã®é¦™ã‚Š
- ã‚¿ã‚¤ãƒ ï¼šã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ã§ãƒãƒ¼ãƒãƒ«ãªæ¸©ã‹ã¿ã®ã‚ã‚‹é¦™ã‚Š

ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒˆï¼š
- ãƒ­ãƒ¼ã‚ºï¼šè¯ã‚„ã‹ã§ç”˜ãå„ªé›…ãªãƒãƒ©ã®èŠ±ã®é¦™ã‚Š
- ã‚¤ãƒ©ãƒ³ã‚¤ãƒ©ãƒ³ï¼šç”˜ç¾ã§ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ãªå—å›½ã®èŠ±ã®é¦™ã‚Š
- ã‚«ãƒ¢ãƒŸãƒ¼ãƒ«ï¼šãƒªãƒ³ã‚´ã®ã‚ˆã†ãªç”˜ã•ã‚’æŒã¤ç©ã‚„ã‹ãªèŠ±ã®é¦™ã‚Š
- ãƒ­ãƒ¼ã‚ºãƒãƒªãƒ¼ï¼šã‚·ãƒ£ãƒ¼ãƒ—ã§æ¸…æ¶¼æ„Ÿã®ã‚ã‚‹ãƒãƒ¼ãƒ–ã®é¦™ã‚Š
- ã‚¯ãƒ©ãƒªã‚»ãƒ¼ã‚¸ï¼šã‚„ã‚„ç”˜ããƒãƒ¼ãƒãƒ«ã§è½ã¡ç€ã„ãŸé¦™ã‚Š
- ã‚¸ãƒ³ã‚¸ãƒ£ãƒ¼ï¼šã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ã§æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚·ãƒ§ã‚¦ã‚¬ã®é¦™ã‚Š
- ã‚·ãƒŠãƒ¢ãƒ³ï¼šç”˜ãã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ã§æ¸©ã‹ã¿ã®ã‚ã‚‹æ¨¹çš®ã®é¦™ã‚Š
- ã‚¯ãƒ­ãƒ¼ãƒ–ï¼šç”˜ã•ã®ä¸­ã«é‹­ã•ã‚’æŒã¤æ¿ƒåšãªã‚¹ãƒ‘ã‚¤ã‚¹ã®é¦™ã‚Š

ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼š
- ã‚µãƒ³ãƒ€ãƒ«ã‚¦ãƒƒãƒ‰ï¼šæŸ”ã‚‰ã‹ã§ç”˜ã„ã‚¦ãƒƒãƒ‡ã‚£ãªé¦™ã‚Š
- ã‚·ãƒ€ãƒ¼ã‚¦ãƒƒãƒ‰ï¼šä¹¾ã„ãŸæ¨¹æœ¨ã®è½ã¡ç€ã„ãŸé¦™ã‚Š
- ãƒ‘ãƒãƒ¥ãƒªï¼šåœŸã£ã½ãç”˜ã„ã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ãªé¦™ã‚Š
- ãƒ™ãƒãƒãƒ¼ï¼šæ·±ãåœŸå£Œã®ã‚ˆã†ãªè½ã¡ç€ã„ãŸé¦™ã‚Š
- ãƒãƒ‹ãƒ©ï¼šç”˜ãæ¸©ã‹ã¿ã®ã‚ã‚‹é¦™ã‚Š
- ãƒ•ãƒ©ãƒ³ã‚­ãƒ³ã‚»ãƒ³ã‚¹ï¼šæ¾„ã‚“ã æ¨¹æœ¨ã¨æŸ‘æ©˜ãŒæ··ã–ã‚‹ç¥è–ãªé¦™ã‚Š
- ãƒŸãƒ«ãƒ©ï¼šè‹¦å‘³ã®ã‚ã‚‹ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ã§é‡ã„æ¨¹è„‚ã®é¦™ã‚Š

# ğŸ’¬ ä¼šè©±ã®æµã‚Œï¼š
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã«å¯¾ã—ã¦å¿…ãšå…±æ„Ÿã‚’ç¤ºã™
2. é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹éš›ã¯ã€å¿…ãšå„é¸æŠè‚¢ã®ç‰¹å¾´ã‚’èª¬æ˜ã™ã‚‹
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«å¯¾ã—ã¦ã¯å¿…ãšãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã‚‹
4. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€éš›ã¯ã€å¿…ãšç¾åœ¨ã®é¸æŠã‚’ç¢ºèªã™ã‚‹

# ğŸ’¡ é‡è¦ï¼šé¸æŠè‚¢ã®æç¤ºæ–¹æ³•
é¸æŠè‚¢ã‚’æç¤ºã™ã‚‹éš›ã¯ã€å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "content": "ã©ã®é¦™ã‚ŠãŒã„ã„ã§ã™ã‹ï¼Ÿ\n\nãã‚Œãã‚Œã®ç‰¹å¾´ã‚’èª¬æ˜ã•ã›ã¦ãã ã•ã„ï¼",
  "choices": ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"]
}
\`\`\`

# ğŸ’¡ ãƒ¬ã‚·ãƒ”ãŒå®Œæˆã—ãŸã‚‰ï¼š
å®Œæˆã—ãŸãƒ¬ã‚·ãƒ”ã¯ä»¥ä¸‹ã®å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "content": "ç´ æ•µãªãƒ¬ã‚·ãƒ”ãŒã§ãã¾ã—ãŸã­ï¼\n\nã“ã®çµ„ã¿åˆã‚ã›ã§é€²ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
  "recipe": {
    "top_notes": ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ"],
    "middle_notes": ["ãƒ­ãƒ¼ã‚º", "ã‚¤ãƒ©ãƒ³ã‚¤ãƒ©ãƒ³"],
    "base_notes": ["ã‚µãƒ³ãƒ€ãƒ«ã‚¦ãƒƒãƒ‰", "ãƒãƒ‹ãƒ©"],
    "name": "Morning Bloom",
    "description": "çˆ½ã‚„ã‹ã§è¯ã‚„ã‹ã€æ˜¥ã®æœã«ã´ã£ãŸã‚Šãªé¦™ã‚Šã§ã™ã€‚"
  },
  "choices": ["ã¯ã„", "ã„ã„ãˆ"]
}
\`\`\`

# ğŸ‘€ ãã®ä»–ãƒ«ãƒ¼ãƒ«ï¼š
- å¿…ãšæ–‡ä¸­ã«é¦™æ°´ã®åå‰ã‚’å«ã‚ã¦ãã ã•ã„ï¼ˆAIãŒå‘½åã™ã‚‹ or ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å°‹ã­ã¦ã‚‚OKï¼‰
- æœ€å¾Œã«ã¯é¦™ã‚Šã®ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ·»ãˆã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œã“ã‚Œã¯"ã²ã¨å¤ã®æ€ã„å‡º"ã«ã´ã£ãŸã‚Šã ã¨æ€ã†ãªâ˜€ï¸ã€ï¼‰
- ç›¸æ‰‹ã®é¸æŠã«å¯¾ã—ã¦ã¯ã€Œé¸ã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã€ã®ã‚ˆã†ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„
- ä¸é©åˆ‡ãªè©±é¡Œã«ã¯ã‚„ã‚“ã‚ã‚Šã¨æ³¨æ„ã—ã€é¦™ã‚Šã®è©±é¡Œã«æˆ»ã—ã¦ãã ã•ã„
- å„ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆãƒˆãƒƒãƒ—ãƒãƒ¼ãƒˆã€ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒˆã€ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼‰ã§å¿…ãšé¸æŠè‚¢ã‚’æç¤ºã—ã¦ãã ã•ã„
- é¸æŠè‚¢ã¯å¿…ãš3ã¤æç¤ºã—ã€ãã‚Œãã‚Œã®ç‰¹å¾´ã‚’èª¬æ˜ã—ã¦ãã ã•ã„

å¿…ãšä¸Šè¨˜ã§æŒ‡å®šã—ãŸJSONå½¢å¼ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
`

export async function POST(req: Request) {
  try {
    const { messages }: { messages: ChatMessage[] } = await req.json()

    const latestUserMessage =
      [...messages].reverse().find((m) => m.role === 'user')?.content || ''

    const dynamicInstruction =
      latestUserMessage.length < 20
        ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ãŒçŸ­ã„ã®ã§ã€è¿”ç­”ã‚‚è»½ã‚ã§çŸ­ãã€‚å¿…ãšé¸æŠè‚¢ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚'
        : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ãŒé•·ã‚ãªã®ã§ã€ä¸å¯§ã«å°‘ã—é•·ãå¿œç­”ã—ã¦ãã ã•ã„ã€‚å¿…ãšé¸æŠè‚¢ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚'

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `${systemPrompt}\n\n${dynamicInstruction}`,
        },
        ...messages,
      ],
      temperature: 0.7,
    })

    const result = completion.choices[0]?.message?.content

    if (!result) {
      return NextResponse.json({
        content: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚å¿œç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
        choices: ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"],
        recipe: null
      })
    }

    // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã‚’è©¦ã¿ã‚‹
    try {
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡º
      const jsonMatch = result.match(/```json\n([\s\S]*?)\n```/)
      const jsonStr = jsonMatch ? jsonMatch[1] : result
      
      const jsonResponse = JSON.parse(jsonStr)
      
      // é¸æŠè‚¢ã®èª¬æ˜æ–‡ã‚’æŠ½å‡º
      if (jsonResponse.choices && Array.isArray(jsonResponse.choices)) {
        const choices_descriptions: { [key: string]: string } = {}
        const lines = ((jsonResponse.content || '') as string).split('\n')
        
        for (const line of lines as string[]) {
          const match = line.match(/^- ([^:]+): (.+)$/)
          if (match) {
            const [_, name, description] = match as [string, string, string]
            choices_descriptions[name] = description
          }
        }

        // èª¬æ˜æ–‡ã‚’å«ã¾ãªã„ç´”ç²‹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’æŠ½å‡º
        const raw = jsonResponse?.content ?? ''
        const content = raw
          .split('\n')
          .filter((line: string): boolean => {
            return !line.match(/^- [^:]+: .+$/)
          })
          .join('\n')
          .replace(/```json[\s\S]*?```/g, '') // JSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
          .trim()

        // é¸æŠè‚¢ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é¸æŠè‚¢ã‚’è¨­å®š
        const choices = jsonResponse.choices?.length > 0 
          ? jsonResponse.choices 
          : ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"]

        return NextResponse.json({
          content: content || 'é¸æŠè‚¢ã‹ã‚‰é¦™ã‚Šã‚’ãŠé¸ã³ãã ã•ã„ï¼š',
          choices: choices,
          choices_descriptions: choices_descriptions ?? {},
          recipe: jsonResponse.recipe ?? null,
          emotionScores: jsonResponse.emotionScores ?? null
        })
      }
      
      return NextResponse.json({
        content: jsonResponse.content || 'é¦™ã‚Šã‚’ææ¡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ğŸ«§',
        choices: jsonResponse.choices ?? ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"],
        recipe: jsonResponse.recipe ?? null,
        emotionScores: jsonResponse.emotionScores ?? null
      })
    } catch (error) {
      console.error('JSON Parse Error:', error)
      // JSONã§ãªã„å ´åˆã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦æ‰±ã†
      const cleaned = result
        .replace(/```json[\s\S]*?```/g, '') // JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
        .replace(/"json[\s\S]*?}/g, '') // ç”Ÿã®JSONã‚’å‰Šé™¤
        .trim()

      return NextResponse.json({
        content: cleaned || 'é¦™ã‚Šã‚’ææ¡ˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™ğŸ«§',
        choices: ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"]
      })
    }
  } catch (error) {
    console.error('Chat API Error:', error)
    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
    if (error instanceof Error) {
      console.error('Error details:', {
        message: error.message,
        stack: error.stack,
        name: error.name
      })
    }
    return NextResponse.json({ 
      content: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
      choices: ["ãƒ¬ãƒ¢ãƒ³", "ãƒ™ãƒ«ã‚¬ãƒ¢ãƒƒãƒˆ", "ãƒšãƒ‘ãƒ¼ãƒŸãƒ³ãƒˆ"],
      error: error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'
    }, { status: 500 })
  }
}
