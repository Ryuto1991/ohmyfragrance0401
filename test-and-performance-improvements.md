# テストカバレッジと性能モニタリングの改善

このドキュメントでは、フレグランスチャットアプリケーションに追加したテストカバレッジ拡張と性能モニタリング自動化の概要を説明します。

## テストカバレッジの拡張

### 1. カスタムフックのテスト強化

- **useScentsSelection の完全なテスト追加**
  - 初期化時の状態検証
  - ローカルストレージからのレシピ読み込み
  - 香り選択機能の動作確認
  - フェーズごとの香り選択の検証
  - 全ての香りが選択された場合の自動保存処理
  - 無効なフェーズでの香り選択に対するエラーハンドリング

### 2. スナップショットテストの導入

- **ChatProgressSteps のスナップショットテスト**
  - 各フェーズごとの表示状態の検証
  - モバイルビューとデスクトップビューの表示差異の検証

- **FragranceAIChat のスナップショットテスト**
  - 初期状態の表示検証
  - 初期クエリがある場合の表示検証

### 3. エッジケースのテスト強化

- **useChatState のエッジケーステスト**
  - ネットワークタイムアウト時の適切なエラーハンドリング
  - 大量のメッセージがある場合のパフォーマンス検証
  - 連続した複数のメッセージ送信の適切な処理
  - ネットワークエラーからの回復処理
  - ローカルストレージが利用できない場合の対応
  - 無効なJSONレスポンスの処理
  - レート制限エラー(HTTP 429)の処理

## パフォーマンス測定の自動化

### 1. パフォーマンス測定スクリプト

- **`scripts/performance-monitor.js`**
  - Lighthouse を使用したWeb Vitalsの自動測定
  - 以下の指標を測定:
    - パフォーマンススコア
    - アクセシビリティスコア
    - SEOスコア
    - First Contentful Paint (FCP)
    - Largest Contentful Paint (LCP)
    - Time to Interactive (TTI)
    - Cumulative Layout Shift (CLS)
    - Total Blocking Time (TBT)
  - 測定結果をHTML形式とJSONデータで保存
  - パフォーマンストレンドの自動分析と改善/悪化の追跡

### 2. パフォーマンスしきい値の定義

- **`scripts/performance-thresholds.js`**
  - Web Vitalsの目標値設定:
    - Performance Score: 80%以上
    - FCP: 1.8秒以下
    - LCP: 2.5秒以下
    - TTI: 3.5秒以下
    - CLS: 0.1以下
  - アプリケーション固有のしきい値設定:
    - チャットレスポンス時間: 1秒以下
    - 初期読み込み時間: 2秒以下

### 3. CI/CDパイプラインとの統合

- **`.github/workflows/performance.yml`**
  - 以下のタイミングで自動実行:
    - プッシュ時（mainブランチ）
    - プルリクエスト時
    - 毎日午前3時の定期実行
    - 手動実行（workflow_dispatch）
  - パフォーマンス測定の自動実行
  - 測定結果のGitHub Actionsアーティファクトとしての保存
  - パフォーマンス悪化の検出と警告
  - プルリクエスト時の結果サマリーコメントの自動投稿

## 使用方法

### テストの実行

```bash
# 全テストの実行
npm test

# 特定のテストファイルの実行
npm test -- __tests__/hooks/useScentsSelection.test.tsx

# スナップショットテストの更新（UI変更後）
npm test -- -u
```

### パフォーマンス測定の実行

```bash
# 手動でパフォーマンス測定を実行
node scripts/performance-monitor.js

# GitHub Actionsでのパフォーマンス測定を手動トリガー
# (GitHubリポジトリのActionsタブから「Performance Tests」ワークフローを実行)
```

## 今後の改善ポイント

1. **E2E（エンドツーエンド）テストの追加**
   - Playwrightを使用した実際のユーザー操作シナリオのテスト

2. **モバイルデバイスに特化したパフォーマンステスト**
   - 低速ネットワーク条件下でのパフォーマンス測定

3. **テストカバレッジレポート**
   - Jest Coverage Reportの設定と定期的な監視

4. **ビジュアルリグレッションテスト**
   - Storybookと連携したビジュアルテスト自動化

5. **ユーザー体験指標（CWV）の改善目標設定**
   - 段階的なパフォーマンス改善目標とロードマップ作成
